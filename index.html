<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APT AUTH ‚Äî Mock iPhone Demo</title>
  <style>
    :root{
    --bg:#000000;
    --bg2:#1f1f1f;
    --phone:#0b0c10;

    --text:#f2f2f2;
    --muted:#9a9a9a;

    --card:#262626;
    --line: rgba(255,255,255,.08);

    --accent:#ff8c1a;
    --accent2:#ffb347;

    --good:#2ed573;
    --warn:#ffa502;
    --bad:#ff4757;

    --shadow: 0 40px 120px rgba(0,0,0,.65);
    --radius: 14px;
    --navH: 74px;
    }


    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(255,122,0,.18), transparent 60%),
        radial-gradient(800px 600px at 80% 80%, rgba(255,176,102,.18), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    /* iPhone frame */
    .phone-wrap{
        width:min(390px, 92vw);
        aspect-ratio: 9 / 19.5;
        position:relative;
        border-radius: 58px;
        background: linear-gradient(180deg, #2b2c35, #06060a);
        box-shadow: var(--shadow);
        padding: 18px;
    }

    .phone{
        width:100%;
        height:100%;
        border-radius: 46px;
        background: #040406;
        padding: 10px;
        position:relative;
        overflow:hidden;
        border: 1px solid rgba(255,255,255,.10);
    }
    .notch{
        position:absolute;
        top:14px;
        left:50%;
        transform:translateX(-50%);
        width: 170px;
        height: 36px;
        border-radius: 20px;
        background: rgba(0,0,0,.78);
        border: 1px solid rgba(255,255,255,.10);
        z-index:6;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        color: rgba(255,255,255,.65);
        font-size:12px;
    }

    .notch .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.25)}
    .status{
        position:absolute;
        top:26px;
        left:0;
        right:0;
        padding: 0 22px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        color: rgba(255,255,255,.88);
        font-size: 12px;
        z-index:7;
        pointer-events:none;
        mix-blend-mode: normal;
    }


    /* Screen layout */
    .screen{
        width:100%;
        height:100%;
        border-radius: 36px;
        background: #222222;
        position:relative;
        overflow:hidden;
        display:flex;
        flex-direction:column;
        color: var(--text);
    }


        /* Sticky header area inside the app */
    .appHeader{
        padding: 76px 14px 10px;
        position:sticky;
        top:0;
        z-index:4;
        background: linear-gradient(180deg, rgba(34,34,34,.96), rgba(34,34,34,.86));
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,.08);
    }


    /* Scrollable content area (extra padding bottom for taskbar) */
    .appScroll{
      padding: 10px 14px calc(16px + var(--navH));
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1;
    }

    .bottomNav{
        position:absolute;
        left:0; right:0; bottom:0;
        height: var(--navH);
        padding: 10px 12px 12px;
        background: rgba(24,24,24,.96);
        backdrop-filter: blur(12px);
        border-top: 1px solid rgba(255,255,255,.10);
        z-index: 8;
    }
    .navItem{
        flex:1;
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 16px;
        background: rgba(255,255,255,.05);

        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap: 4px;

        padding: 8px 6px;
        cursor:pointer;
        user-select:none;
        }

    .navItem .ico{
        width: 28px;
        height: 28px;
        border-radius: 12px;

        display:flex;
        align-items:center;
        justify-content:center;

        background: rgba(255,122,0,.10);
        border: 1px solid rgba(255,122,0,.25);
        font-size: 16px;
        line-height: 1;
    }

    .navItem.active{
        background: linear-gradient(135deg, rgba(255,140,26,.22), rgba(255,179,71,.10));
        border-color: rgba(255,140,26,.35);
    }

    .navItem .lbl{
        font-size: 10px;
        line-height: 1;
        font-weight: 700;
        color: rgba(255,255,255,.78);
        text-align:center;
        width:100%;
    }


    .navRow{
      height: 100%;
      display:flex;
      gap: 10px;
      align-items:stretch;
      justify-content:space-between;
    }

    .navItem .ico{
      width: 28px; height: 28px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: rgba(255,122,0,.10);
      border: 1px solid rgba(255,122,0,.25);
      font-size: 16px;
    }
    .navItem.active .ico{
      background: rgba(255,122,0,.18);
      border-color: rgba(255,122,0,.45);
    }

        /* Memory checkmark key (data-dir="S") green */
    #gameMemory .pad button[data-dir="S"]{
        background: rgba(33,180,107,.22);
        border-color: rgba(33,180,107,.45);
        color: rgba(255,255,255,.92);
    }
    #gameMemory .pad button[data-dir="S"]:disabled{
        opacity:.35;
    }


    .app-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand b{font-size:16px; letter-spacing:.3px}
    .brand span{font-size:12px; color:var(--muted)}
    .pill{
        font-size:12px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,140,26,.10);
        color: rgba(255,255,255,.92);
        display:flex;
        align-items:center;
        gap:6px;
        user-select:none;
        white-space:nowrap;
    }
    .pill .led{background: rgba(255,255,255,.30)}

    .pill .led{
      width:8px;height:8px;border-radius:50%;
      background: rgba(0,0,0,.25);
      box-shadow:none;
    }
    .pill.good .led{background: var(--good); box-shadow: 0 0 12px rgba(33,180,107,.35)}
    .pill.warn .led{background: var(--warn); box-shadow: 0 0 12px rgba(244,163,0,.35)}
    .pill.bad  .led{background: var(--bad);  box-shadow: 0 0 12px rgba(226,59,79,.35)}

    .card{
        background: linear-gradient(180deg, #2a2a2a, #1f1f1f);
        border: 1px solid rgba(255,255,255,.09);
        border-radius: var(--radius);
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 12px 34px rgba(0,0,0,.55);
    }

    .row{display:flex; gap:10px; align-items:stretch}
    .col{flex:1}
    .kvs{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      align-items:center;
      font-size: 12px;
    }
    .kvs .k{color: var(--muted)}
    .kvs .v{color: rgba(255,255,255,.92); font-variant-numeric: tabular-nums}

    .divider{height:1px;background:rgba(255,255,255,.09); margin: 10px 0}


    .btns{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
        flex:1;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.92);
        font-weight: 800;
        font-size: 13px;
        cursor:pointer;
        user-select:none;
        min-width: 120px;
    }
    .btn.primary{
        background: linear-gradient(135deg, rgba(255,140,26,.98), rgba(255,179,71,.85));
        border-color: rgba(255,140,26,.55);
        color: #111;
        box-shadow: 0 8px 26px rgba(255,140,26,.25);
    }
    .btn:disabled{opacity:.45; cursor:not-allowed;}

    .btn.danger{
      background: linear-gradient(135deg, rgba(226,59,79,.92), rgba(244,163,0,.35));
      border-color: rgba(226,59,79,.45);
      color:#111;
    }

    .mini{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.35;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: rgba(255,122,0,.06);
      margin-right: 6px;
      margin-top: 6px;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(0,0,0,.35);
    }
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .section-title b{font-size:13px}
    .section-title span{font-size:11px;color:var(--muted)}
    .stack{display:flex; flex-direction:column; gap:10px}

    .game{
        background: rgba(255,140,26,.07);
        border: 1px solid rgba(255,140,26,.22);
        border-radius: 16px;
        padding: 12px;
    }
    .game p{ color: var(--muted); }

    .game h3{ margin:0 0 6px; font-size: 13px; }


    .hud{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .hud .chip{
        padding: 6px 10px;
        border-radius: 999px;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.18);
        font-size: 12px;
        font-variant-numeric: tabular-nums;
        color: rgba(255,255,255,.92);
    }


    .bigTap{
        width:100%;
        padding: 14px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.92);
        font-weight:900;
        letter-spacing:.5px;
        cursor:pointer;
        user-select:none;
        text-align:center;
        margin-bottom: 8px;
    }

    .bigTap.ready{ background: rgba(255,176,102,.55); border-color: rgba(255,122,0,.40) }
    .bigTap.go{ background: rgba(255,122,0,.38); border-color: rgba(255,122,0,.55) }
    .bigTap.tooSoon{ background: rgba(226,59,79,.18); border-color: rgba(226,59,79,.35) }

    .pad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 6px;
    }
    .pad button{
      padding: 12px 0;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
      color: rgba(0,0,0,.92);
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
    }
    .pad button:active{transform:translateY(1px)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}

    canvas{
        width:100%;
        height: 160px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.25);
        display:block;
    }

    input[type="number"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.8);
      color: rgba(0,0,0,.9);
      outline:none;
      font-size: 13px;
    }

    .toast{
      position:absolute;
      left: 12px;
      right: 12px;
      bottom: calc(16px + var(--navH));
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      color: rgba(0,0,0,.9);
      font-size: 12px;
      opacity:0;
      transform: translateY(8px);
      transition: .25s ease;
      pointer-events:none;
      z-index: 10;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .log{
        max-height: 120px;
        overflow:auto;
        font-size: 11px;
        color: rgba(255,255,255,.92);
        line-height: 1.35;
    }

    .log div{
        padding: 4px 0;
        border-bottom: 1px dashed rgba(255,255,255,.18);
    }

    .log div:last-child{
        border-bottom:none;
    }


    .smalllink{
      font-size: 12px;
      color: rgba(0,0,0,.78);
      text-decoration: underline;
      cursor:pointer;
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="phone-wrap">
    <div class="phone">
      <div class="notch"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      <div class="status">
        <span id="timeNow">‚Äî</span>
        <span class="mono">LTE ‚ñ™Ô∏é 100%</span>
      </div>

      <div class="screen" id="screen">
        <!-- Sticky header -->
        <div class="appHeader">
          <div class="app-title">
            <div class="brand" style="flex-direction:row; align-items:center; gap:10px">
              <img
                src="aptauth.png"
                alt="APT AUTH Logo"
                style="height:26px; width:auto;"
              />
              <div style="display:flex; flex-direction:column; gap:2px">
                <b>APT AUTH</b>
                <span>Clock-in verification mock</span>
              </div>
            </div>

            <div id="riskPill" class="pill">
              <span class="led"></span>
              <span id="riskText">No test yet</span>
            </div>
          </div>
        </div>


        <!-- Scroll area -->
        <div class="appScroll" id="appScroll">

          <!-- CLOCK TAB -->
          <div id="tab-clock" class="tabpane">
            <div class="card">
              <div class="section-title">
                <b>Clock-In Gate</b>
                <span id="gateHint">On-site + Pass tests</span>
              </div>

              <div class="kvs">
                <div class="k">Location</div><div class="v" id="locStatus">Unknown</div>
                <div class="k">Distance to site</div><div class="v" id="locDistance">‚Äî</div>
                <div class="k">Geofence</div><div class="v" id="locFence">‚Äî</div>
                <div class="k">Test pack</div><div class="v" id="testStatus">Not completed</div>
                <div class="k">Decision</div><div class="v" id="decisionStatus">‚Äî</div>
              </div>

              <div class="divider"></div>

              <div class="btns">
                <button class="btn primary" id="btnClockIn" disabled>Clock In</button>
                <button class="btn" id="btnClockOut" disabled>Clock Out</button>
              </div>

              <div class="divider"></div>
              <div class="mini">
                <div class="tag"><span class="dot good"></span>EXPECTED: ‚â§ 10‚Äì15% below baseline</div>
                <div class="tag"><span class="dot warn"></span>FLAG: 15‚Äì40% below baseline</div>
                <div class="tag"><span class="dot bad"></span>HIGH RISK: ‚â• 40% below baseline</div>
                <div style="margin-top:8px">
                  Work-site scoring includes <b>+10‚Äì15% leniency</b> for site noise.
                </div>
              </div>
            </div>

            <div class="card">
              <div class="section-title">
                <b>Recent Activity</b>
                <span class="smalllink" id="clearLog">Clear</span>
              </div>
              <div class="log" id="log"></div>
            </div>
          </div>

          <!-- TESTS TAB -->
          <div id="tab-tests" class="tabpane" style="display:none">
            <div class="card">
              <div class="section-title">
                <b>Verification Tests</b>
                <span id="testsSubtitle">3 required</span>
              </div>
              <div class="mini">
                Complete all tests, then tap <b>Finalize & Evaluate</b>. If you pass and you‚Äôre inside the geofence,
                you can clock in.
              </div>
            </div>

            <div class="stack">
              <!-- Reaction -->
              <div class="game" id="gameReaction">
                <h3>1) Reaction Time Game</h3>
                <p> Keep your finger off the screen until ‚ÄúGO‚Äù appears. When it does, tap immediately. Tapping early counts as an error. The game runs three times.</p>
                <div class="hud">
                  <div class="chip">Trials: <span class="mono" id="rtTrials">0/3</span></div>
                  <div class="chip">Best: <span class="mono" id="rtBest">‚Äî</span> ms</div>
                  <div class="chip">Lapses: <span class="mono" id="rtLapses">0</span></div>
                </div>
                <div class="bigTap" id="rtPad">START</div>
              </div>

              <!-- Memory (3 rounds randomized) -->
              <div class="game" id="gameMemory">
                <h3>2) Memory Pattern Game</h3>
                <p>
                  A sequence of arrows will appear. Watch it closely. When it finishes, repeat the sequence by tapping the arrows in the same order. You‚Äôll do this three times.
                </p>

                <div class="hud">
                  <div class="chip">Round: <span class="mono" id="memRound">0</span>/3</div>
                  <div class="chip">Length: <span class="mono" id="memLen">‚Äî</span></div>
                  <div class="chip">Avg Score: <span class="mono" id="memAvg">‚Äî</span></div>
                </div>

                <div style="padding:10px;border-radius:14px;border:1px solid rgba(255,122,0,.25);background:rgba(255,255,255,.75); color:#000">
                  <div class="mini" style="color:#000">Display:</div>
                  <div class="mono" id="memDisplay" style="font-size:14px;margin-top:6px; color:#000">
                    Tap Start
                  </div>
                </div>


                <div class="btns" style="margin-top:10px">
                  <button class="btn primary" id="memStart">Start Round</button>
                </div>

                <div class="pad">
                  <button data-dir="U">‚Üë</button>
                  <button disabled> </button>
                  <button data-dir="D">‚Üì</button>
                  <button data-dir="L">‚Üê</button>
                  <button data-dir="S">‚úì</button>
                  <button data-dir="R">‚Üí</button>
                </div>

                <div class="mini" style="margin-top:8px">
                  After Start, the arrows unlock. Enter the full sequence, then tap ‚úì to submit.
                </div>
              </div>

              <!-- Tracking -->
              <div class="game" id="gameTracking">
                <h3>3) Tracking Ability Game</h3>
                <p>An orange ball will move around the circle for 10 seconds. Count each time it touches the edge. When the motion stops, enter the number you counted.</p>
                <div class="hud">
                  <div class="chip">Timer: <span class="mono" id="trkTimer">‚Äî</span></div>
                  <div class="chip">Round: <span class="mono" id="trkRound">0</span></div>
                  <div class="chip">Result: <span class="mono" id="trkResult">‚Äî</span></div>
                </div>
                <canvas id="trkCanvas" width="320" height="160"></canvas>
                <div style="margin-top:10px" class="row">
                  <div class="col">
                    <input id="trkGuess" type="number" min="0" placeholder="Enter your count‚Ä¶" />
                  </div>
                  <div style="width:120px">
                    <button class="btn" id="trkSubmit">Submit</button>
                  </div>
                </div>
                <div class="btns" style="margin-top:10px">
                  <button class="btn primary" id="trkStart">Start Round</button>
                </div>
              </div>

              <div class="card">
                <div class="section-title">
                  <b>Test Pack</b>
                  <span id="packHint">Finalize to unlock clock-in</span>
                </div>
                <div class="btns">
                  <button class="btn primary" id="btnFinalize" disabled>Finalize & Evaluate</button>
                  <button class="btn" id="btnSendApi" disabled>Send to Payroll API (mock)</button>
                </div>
                <div class="mini" style="margin-top:10px">
                  Evaluation compares to your baseline (or demo defaults if you don‚Äôt have one yet).
                  Work-site leniency reduces measured degradation by <b>10‚Äì15%</b>.
                </div>
              </div>
            </div>
          </div>

          <!-- BASELINE TAB -->
          <div id="tab-baseline" class="tabpane" style="display:none">
            <div class="card">
              <div class="section-title">
                <b>Baseline (Home Weekly)</b>
                <span id="baselineDate">No baseline saved</span>
              </div>
              <div class="mini">
                Save a personal baseline after completing the tests under normal conditions (weekly). Stored locally in this demo.
              </div>
              <div class="divider"></div>
              <div class="kvs">
                <div class="k">Reaction (best ms)</div><div class="v" id="blRt">‚Äî</div>
                <div class="k">Memory (avg length)</div><div class="v" id="blMem">‚Äî</div>
                <div class="k">Tracking (error %)</div><div class="v" id="blTrk">‚Äî</div>
              </div>
              <div class="divider"></div>
              <div class="btns">
                <button class="btn primary" id="btnSaveBaseline" disabled>Save Current as Baseline</button>
                <button class="btn danger" id="btnClearBaseline">Delete Baseline</button>
              </div>
            </div>
          </div>

          <!-- HOST TAB -->
          <div id="tab-host" class="tabpane" style="display:none">
            <div class="card">
              <div class="section-title">
                <b>Host / Site Controls</b>
                <span class="mini">Owner sets geofence + leniency</span>
              </div>

              <div class="kvs">
                <div class="k">Site (lat, lon)</div><div class="v mono" id="siteCoords">‚Äî</div>
                <div class="k">Allowed radius</div><div class="v mono" id="siteRadius">‚Äî</div>
                <div class="k">Leniency</div><div class="v mono" id="leniency">‚Äî</div>
                <div class="k">Policy</div><div class="v" id="policyText">‚Äî</div>
              </div>

              <div class="divider"></div>

              <div class="btns">
                <button class="btn" id="btnUseGps">Use GPS (browser)</button>
                <button class="btn primary" id="btnUseMock">Use Mock Location</button>
              </div>

              <div class="divider"></div>

              <div class="mini">Demo mode: set your ‚Äúdistance from site‚Äù without real GPS.</div>
              <div style="margin-top:10px">
                <input id="mockDistance" type="range" min="0" max="2000" value="1200" style="width:100%" />
                <div class="kvs" style="margin-top:8px">
                  <div class="k">Mock distance</div><div class="v mono"><span id="mockDistanceLabel">1200</span> m</div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Bottom nav -->
        <div class="bottomNav">
          <div class="navRow">
            <div class="navItem active" data-tab="clock">
              <div class="ico">‚è±Ô∏è</div>
              <div class="lbl">Clock</div>
            </div>
            <div class="navItem" data-tab="tests">
              <div class="ico">üß†</div>
              <div class="lbl">Tests</div>
            </div>
            <div class="navItem" data-tab="baseline">
              <div class="ico">üìà</div>
              <div class="lbl">Baseline</div>
            </div>
            <div class="navItem" data-tab="host">
              <div class="ico">üìç</div>
              <div class="lbl">Host</div>
            </div>
          </div>
        </div>

        <div class="toast" id="toast">‚Äî</div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
const now = ()=>new Date();
function fmtTime(d){ return String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0'); }
function fmtDateTime(d){ return d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._to);
  toast._to = setTimeout(()=>t.classList.remove("show"), 2200);
}
function log(msg){
  const el = $("log");
  const row = document.createElement("div");
  row.textContent = `[${fmtTime(now())}] ${msg}`;
  el.prepend(row);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function pctWorse(cur, base){ return base===0?0:((cur-base)/base)*100; }  // higher worse
function pctLower(cur, base){ return base===0?0:((base-cur)/base)*100; }  // lower worse

/* Status time */
setInterval(()=>{$("timeNow").textContent = fmtTime(now());}, 500);
$("timeNow").textContent = fmtTime(now());

/* =========================
   Host config
   ========================= */
const HOST = {
  siteLat:43.6532,
  siteLon:-79.3832,
  radiusM:250,
  leniencyPct:12.5,
  policy:"Clock-in only allowed on-site + must pass APT AUTH tests."
};

/* Storage */
const KEY_BASELINE="apt_auth_baseline_v1";
const KEY_SHIFT="apt_auth_shift_v1";

/* State */
let locationMode="mock";
let gpsState={ok:false,lat:null,lon:null,accuracy:null};
let mockState={distanceM:1200};

let pack={
  reaction:{done:false,bestMs:null,lapses:0},
  memory:{done:false,avgLen:0},         // NEW metric: avg correct length across 3 rounds
  tracking:{done:false,errorPct:null,trueHits:null,guess:null}
};
let evaluation={done:false,risk:"none",overallDegradationPct:null};

/* =========================
   Bottom nav switching
   ========================= */
function showTab(name){
  document.querySelectorAll(".tabpane").forEach(p=>p.style.display="none");
  $("tab-"+name).style.display="block";

  document.querySelectorAll(".navItem").forEach(n=>n.classList.remove("active"));
  document.querySelectorAll(`.navItem[data-tab="${name}"]`).forEach(n=>n.classList.add("active"));

  $("appScroll").scrollTo({top:0, behavior:"smooth"});

  // IMPORTANT: tracking canvas must be initialized when visible
  if(name==="tests"){
    setTimeout(()=>{
      trkEnsureVisibleInit();
    }, 50);
  }
}

document.querySelectorAll(".navItem").forEach(item=>{
  item.addEventListener("click", ()=> showTab(item.dataset.tab));
});

/* =========================
   Baseline
   ========================= */
function loadBaseline(){ const r=localStorage.getItem(KEY_BASELINE); return r?JSON.parse(r):null; }
function saveBaseline(bl){ localStorage.setItem(KEY_BASELINE, JSON.stringify(bl)); }
function clearBaseline(){ localStorage.removeItem(KEY_BASELINE); }
function defaultBaseline(){
  return {
    savedAt:Date.now(),
    reactionBestMs:260,
    memoryAvgLen:4.0,      // average correct length out of 3 rounds
    trackingErrorPct:12.0
  };
}
function renderBaseline(){
  const bl = loadBaseline();

  // ---- Top label (saved baseline status) ----
  if(!bl){
    $("baselineDate").textContent = "No baseline saved";
  } else {
    $("baselineDate").textContent = `Saved: ${fmtDateTime(new Date(bl.savedAt))}`;
  }

  // ---- ALWAYS show CURRENT RUN results here (auto-updated) ----
  // If not done yet, show ‚Äî.
  $("blRt").textContent  = pack.reaction.done ? `${pack.reaction.bestMs} ms` : "‚Äî";
  $("blMem").textContent = pack.memory.done   ? `${pack.memory.avgLen.toFixed(2)}` : "‚Äî";

  // If you're using my Tracking code: pack.tracking.errorPct is the AVG error across 3 rounds.
  $("blTrk").textContent = pack.tracking.done ? `${pack.tracking.errorPct.toFixed(1)}%` : "‚Äî";
}

// initial paint
renderBaseline();

/* Host UI */
$("siteCoords").textContent = `${HOST.siteLat.toFixed(4)}, ${HOST.siteLon.toFixed(4)}`;
$("siteRadius").textContent = `${HOST.radiusM} m`;
$("leniency").textContent = `${HOST.leniencyPct.toFixed(1)}%`;
$("policyText").textContent = HOST.policy;
$("mockDistanceLabel").textContent = mockState.distanceM;

/* =========================
   Location / geofence
   ========================= */
function haversineMeters(lat1, lon1, lat2, lon2){
  const R=6371000, toRad=(x)=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function computeDistanceToSite(){
  if(locationMode==="gps" && gpsState.ok){
    return haversineMeters(gpsState.lat,gpsState.lon,HOST.siteLat,HOST.siteLon);
  }
  return mockState.distanceM;
}
function getLocationStatusText(){
  if(locationMode==="gps"){
    if(!gpsState.ok) return "GPS unavailable / blocked";
    return `GPS OK (¬±${Math.round(gpsState.accuracy)}m)`;
  }
  return "Mock (demo)";
}
function getCurrentPositionOnce(){
  if(!navigator.geolocation){ toast("Geolocation not supported."); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      gpsState={ok:true,lat:pos.coords.latitude,lon:pos.coords.longitude,accuracy:pos.coords.accuracy};
      toast("GPS captured.");
      updateGate();
    },
    ()=>{
      gpsState.ok=false;
      toast("GPS blocked. Use mock.");
      updateGate();
    },
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
}
$("btnUseGps").addEventListener("click", ()=>{ locationMode="gps"; getCurrentPositionOnce(); updateGate(); });
$("btnUseMock").addEventListener("click", ()=>{ locationMode="mock"; toast("Mock enabled."); updateGate(); });
$("mockDistance").addEventListener("input",(e)=>{
  mockState.distanceM=Number(e.target.value);
  $("mockDistanceLabel").textContent=mockState.distanceM;
  updateGate();
});

/* =========================
   Risk pill
   ========================= */
function setRiskPill(kind,text){
  const pill=$("riskPill");
  pill.classList.remove("good","warn","bad");
  if(kind==="good") pill.classList.add("good");
  if(kind==="warn") pill.classList.add("warn");
  if(kind==="bad") pill.classList.add("bad");
  $("riskText").textContent=text;
}

/* =========================
   Gate + evaluation
   ========================= */
function applyLeniency(deg){ return Math.max(0, deg - HOST.leniencyPct); }
function classifyRisk(eff){
  if(eff < 15) return {risk:"expected", kind:"good", label:"Expected"};
  if(eff < 40) return {risk:"flag", kind:"warn", label:"Flag"};
  return {risk:"high", kind:"bad", label:"High risk"};
}
function canFinalizePack(){ return pack.reaction.done && pack.memory.done && pack.tracking.done; }

function updateGate(){
  const dist=computeDistanceToSite();
  const inside=dist<=HOST.radiusM;

  $("locStatus").textContent=getLocationStatusText();
  $("locDistance").textContent=`${Math.round(dist)} m`;
  $("locFence").textContent=inside?"Inside geofence":"Outside geofence";

  $("testStatus").textContent = evaluation.done
    ? `${evaluation.risk.toUpperCase()} (${evaluation.overallDegradationPct.toFixed(1)}% eff.)`
    : (canFinalizePack() ? "Ready to finalize" : "Incomplete");

  let decision="‚Äî", allowClockIn=false;
  if(!inside) decision="Blocked: Not on site";
  else if(!evaluation.done) decision="Blocked: Tests not passed";
  else if(evaluation.risk==="high") decision="Blocked: High risk";
  else { decision="Allowed"; allowClockIn=true; }
  $("decisionStatus").textContent=decision;

  const shiftRaw=localStorage.getItem(KEY_SHIFT);
  const shift=shiftRaw?JSON.parse(shiftRaw):{clockedIn:false};
  $("btnClockOut").disabled = !shift.clockedIn;
  $("btnClockIn").disabled  = !allowClockIn || shift.clockedIn;

  $("btnFinalize").disabled = !canFinalizePack();
  $("btnSendApi").disabled  = !evaluation.done;
  $("btnSaveBaseline").disabled = !canFinalizePack();

  if(!evaluation.done) setRiskPill("", "No test yet");
}

/* =========================
   Clock in/out
   ========================= */
$("btnClockIn").addEventListener("click", ()=>{
  if(computeDistanceToSite() > HOST.radiusM){ toast("Not inside geofence."); return; }
  if(!evaluation.done){ toast("Complete tests first."); return; }
  if(evaluation.risk==="high"){ toast("Blocked: high risk."); return; }

  localStorage.setItem(KEY_SHIFT, JSON.stringify({clockedIn:true,inAt:Date.now(),lastEval:evaluation,lastPack:pack}));
  log("Clocked IN ‚úÖ (APT AUTH verified)");
  toast("Clocked in!");
  updateGate();
});
$("btnClockOut").addEventListener("click", ()=>{
  const shiftRaw=localStorage.getItem(KEY_SHIFT);
  if(!shiftRaw){ toast("No active shift."); return; }
  const shift=JSON.parse(shiftRaw);
  if(!shift.clockedIn){ toast("No active shift."); return; }
  shift.clockedIn=false; shift.outAt=Date.now();
  localStorage.setItem(KEY_SHIFT, JSON.stringify(shift));
  log("Clocked OUT ‚è±Ô∏è");
  toast("Clocked out!");
  updateGate();
});
$("clearLog").addEventListener("click", ()=>{ $("log").innerHTML=""; toast("Cleared log."); });

/* =========================
   Game 1: Reaction
   ========================= */
/* =========================
   Game 1: Reaction (3 trials only, no spam, no reset)
   ========================= */
let rt = {
  state: "idle",      // idle -> ready -> go -> done
  trials: 0,
  lapses: 0,
  bestMs: null,
  tStart: 0,
  timer: null
};

function rtRender(){
  $("rtTrials").textContent = `${rt.trials}/3`;
  $("rtLapses").textContent = rt.lapses;
  $("rtBest").textContent   = rt.bestMs ?? "‚Äî";

  const pad = $("rtPad");
  pad.classList.remove("ready","go","tooSoon");

  if(rt.state === "idle") pad.textContent = "START";
  if(rt.state === "ready"){ pad.textContent = "WAIT‚Ä¶"; pad.classList.add("ready"); }
  if(rt.state === "go"){ pad.textContent = "GO!"; pad.classList.add("go"); }
  if(rt.state === "done") pad.textContent = "DONE ‚úì";
}

function rtFinish(){
  clearTimeout(rt.timer);
  rt.state = "done";

  pack.reaction.done  = true;
  pack.reaction.bestMs = rt.bestMs ?? 9999;
  pack.reaction.lapses = rt.lapses;

  toast("Reaction complete.");
  rtRender();
  updateGate();
}

function rtNextOrFinish(){
  clearTimeout(rt.timer);

  if(rt.trials >= 3){
    rtFinish();
    return;
  }

  // back to idle waiting for next start
  rt.state = "idle";
  rtRender();
}

function rtScheduleGo(){
  // prevent spam starting while not idle
  if(rt.state !== "idle") return;

  rt.state = "ready";
  rtRender();

  const delay = 900 + Math.random()*1800;
  clearTimeout(rt.timer);

  rt.timer = setTimeout(()=>{
    // if they somehow changed state, ignore
    if(rt.state !== "ready") return;

    rt.state = "go";
    rt.tStart = performance.now();
    rtRender();

    // lapse timeout
    clearTimeout(rt.timer);
    rt.timer = setTimeout(()=>{
      if(rt.state === "go"){
        rt.lapses++;
        rt.trials++;
        toast("Lapse: no response.");
        rtNextOrFinish();
      }
    }, 1200);

  }, delay);
}

$("rtPad").addEventListener("click", ()=>{
  // hard lock after 3
  if(rt.state === "done" || rt.trials >= 3){
    toast("Reaction finished (3/3).");
    return;
  }

  if(rt.state === "idle"){
    rtScheduleGo();
    return;
  }

  // too soon
  if(rt.state === "ready"){
    clearTimeout(rt.timer);
    rt.state = "idle";
    rt.lapses++;
    rt.trials++;

    $("rtPad").classList.add("tooSoon");
    toast("Too soon (lapse).");
    rtNextOrFinish();
    rtRender();
    return;
  }

  // valid tap
  if(rt.state === "go"){
    const ms = Math.round(performance.now() - rt.tStart);
    rt.bestMs = rt.bestMs == null ? ms : Math.min(rt.bestMs, ms);
    rt.trials++;
    toast(`RT: ${ms} ms`);
    rtNextOrFinish();
    rtRender();
    return;
  }
});

rtRender();

/* =========================
   Game 2: Memory (3 rounds only, no spam, no reset)
   Random pattern length 3‚Äì5 each round
   Metric: avg correct length across 3 rounds (0‚Äì5)
   ========================= */
const DIRS = ["U","D","L","R"];
const ICON = { U:"‚Üë", D:"‚Üì", L:"‚Üê", R:"‚Üí" };

let mem = {
  mode: "idle",     // idle -> showing -> entering -> done
  round: 0,         // 0..3
  len: 0,
  sequence: [],
  input: [],
  scores: []        // per round: len if perfect else 0
};

function memAvg(){
  return mem.scores.length
    ? mem.scores.reduce((a,b)=>a+b,0)/mem.scores.length
    : null;
}

function setMemoryPadEnabled(enabled){
  document.querySelectorAll("#gameMemory .pad button").forEach(btn=>{
    const dir = btn.getAttribute("data-dir");
    if(!dir) return;
    btn.disabled = !enabled;
  });
}

function memRender(){
  $("memRound").textContent = mem.round;
  $("memLen").textContent   = mem.len ? mem.len : "‚Äî";
  const avg = memAvg();
  $("memAvg").textContent   = avg == null ? "‚Äî" : avg.toFixed(2);

  // Start is only clickable when idle + rounds remain
  $("memStart").disabled = !(mem.mode === "idle" && mem.round < 3);

  if(mem.mode === "idle" && mem.round < 3){
    $("memDisplay").textContent = "Tap Start";
  }
  if(mem.mode === "done"){
    $("memDisplay").textContent = `Done ‚úì Avg=${(avg ?? 0).toFixed(2)}`;
  }
}

function randomSequence(len){
  const seq = [];
  for(let i=0;i<len;i++){
    seq.push(DIRS[Math.floor(Math.random()*DIRS.length)]);
  }
  return seq;
}

async function memStartRound(){
  // anti-spam
  if(mem.mode !== "idle"){
    toast("Finish the round first.");
    return;
  }
  if(mem.round >= 3){
    toast("Memory finished (3/3).");
    return;
  }

  // lock immediately
  mem.mode = "showing";
  mem.input = [];
  mem.len = 3 + Math.floor(Math.random()*3); // 3..5
  mem.sequence = randomSequence(mem.len);

  setMemoryPadEnabled(false);
  memRender();

  $("memDisplay").textContent = mem.sequence.map(d=>ICON[d]).join(" ");

  const showMs = clamp(900 + mem.sequence.length*320, 1200, 3200);
  await new Promise(r=>setTimeout(r, showMs));

  $("memDisplay").textContent = "‚Ä¢‚Ä¢‚Ä¢";
  mem.mode = "entering";
  setMemoryPadEnabled(true);
  memRender();

  toast("Enter the pattern, then ‚úì");
}

function memFinish(){
  const avg = memAvg() ?? 0;

  pack.memory.done = true;
  pack.memory.avgLen = avg;

  mem.mode = "done";
  setMemoryPadEnabled(false);

  toast("Memory complete.");
  memRender();
  updateGate();
}

$("memStart").addEventListener("click", ()=> memStartRound());

// NOTE: you said remove reset button ‚Äî do not bind it.
// If the button still exists in HTML, hide it via CSS or delete it from HTML.

document.querySelectorAll("#gameMemory .pad button").forEach(btn=>{
  const dir = btn.getAttribute("data-dir");
  if(!dir) return;

  btn.addEventListener("click", ()=>{
    if(mem.mode !== "entering") return;

    // submit
    if(dir === "S"){
      const ok = mem.input.join("") === mem.sequence.join("");
      mem.round++;

      if(ok){
        mem.scores.push(mem.len);
        toast(`Correct ‚úì (+${mem.len})`);
      }else{
        mem.scores.push(0);
        toast("Incorrect ‚úï (+0)");
      }

      mem.mode = "idle";
      setMemoryPadEnabled(false);

      const avg = memAvg() ?? 0;
      $("memDisplay").textContent = mem.round >= 3
        ? `Done ‚úì Avg=${avg.toFixed(2)}`
        : `Round ${mem.round}/3 ‚úì Avg=${avg.toFixed(2)} ‚Äî Tap Start`;

      memRender();

      if(mem.round >= 3){
        memFinish();
      }
      return;
    }

    // input arrows (cap length)
    mem.input.push(dir);
    if(mem.input.length > mem.sequence.length){
      mem.input = mem.input.slice(0, mem.sequence.length);
    }
    $("memDisplay").textContent = mem.input.map(d=>ICON[d]).join(" ");
  });
});

setMemoryPadEnabled(false);
memRender();

/* =========================
   Game 3: Tracking (3 rounds only, no spam, no reset)
   Each round: 10s
   User submits count after each round
   Metric used for evaluation: AVERAGE error% across 3 rounds
   ========================= */
const canvas = $("trkCanvas");
const ctx = canvas.getContext("2d");

let trk = {
  running: false,
  startAt: 0,
  durationMs: 10000,

  round: 0,                 // 0..3
  trueHits: 0,

  awaitingSubmit: false,    // after timer ends
  errors: [],               // error% per round

  ball: null,
  raf: null,
  initialized: false
};

function resizeCanvasForHiDpi(){
  const rect = canvas.getBoundingClientRect();
  if(!rect.width || !rect.height) return false;

  const dpr = window.devicePixelRatio || 1;
  canvas.width  = Math.round(rect.width * dpr);
  canvas.height = Math.round(rect.height * dpr);

  ctx.setTransform(dpr,0,0,dpr,0,0);
  return true;
}

function initBall(){
  const rect = canvas.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  const cx = w/2, cy = h/2;
  const R  = Math.min(w,h)*0.42;

  const size = 7;

  const ang = Math.random()*Math.PI*2;
  const r   = Math.random()*(R - size - 4)*0.6;
  const x   = cx + Math.cos(ang)*r;
  const y   = cy + Math.sin(ang)*r;

  const speed = 2.2 + Math.random()*1.2;
  const dir   = Math.random()*Math.PI*2;
  const vx    = Math.cos(dir)*speed;
  const vy    = Math.sin(dir)*speed;

  trk.ball = { x,y,vx,vy,size };
}

function circleBounce(ball, cx, cy, R){
  const dx = ball.x - cx, dy = ball.y - cy;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const margin = ball.size + 1;

  if(dist + margin > R){
    const nx = dx / (dist || 1);
    const ny = dy / (dist || 1);

    ball.x = cx + nx*(R - margin);
    ball.y = cy + ny*(R - margin);

    const dot = ball.vx*nx + ball.vy*ny;
    ball.vx = ball.vx - 2*dot*nx;
    ball.vy = ball.vy - 2*dot*ny;

    return true;
  }
  return false;
}

function drawTrk(){
  const rect = canvas.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  if(!w || !h || !trk.ball) return;

  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const R  = Math.min(w,h)*0.42;

  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2);
  ctx.strokeStyle = "rgba(0,0,0,.22)";
  ctx.lineWidth = 2; ctx.stroke();

  ctx.beginPath(); ctx.arc(cx,cy,R-14,0,Math.PI*2);
  ctx.strokeStyle = "rgba(255,122,0,.30)";
  ctx.lineWidth = 2; ctx.stroke();

  const b = trk.ball;
  ctx.beginPath();
  ctx.arc(b.x,b.y,b.size+3,0,Math.PI*2);
  ctx.fillStyle = "rgba(255,122,0,1)";
  ctx.fill();

  ctx.fillStyle = "rgba(0,0,0,.70)";
  ctx.font = "12px ui-monospace, Menlo, Monaco, Consolas";
  ctx.fillText("Count edge hits (orange ball)", 10, 18);
}

function tickTrk(){
  const rect = canvas.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  const cx = w/2, cy = h/2;
  const R  = Math.min(w,h)*0.42;

  const b = trk.ball;
  if(!b){ trk.running = false; return; }

  b.x += b.vx;
  b.y += b.vy;

  const hit = circleBounce(b,cx,cy,R);
  if(hit) trk.trueHits++;

  const sp = Math.sqrt(b.vx*b.vx + b.vy*b.vy) || 1;
  const minSp = 1.8, maxSp = 3.2;
  if(sp < minSp){ b.vx = b.vx/sp*minSp; b.vy = b.vy/sp*minSp; }
  if(sp > maxSp){ b.vx = b.vx/sp*maxSp; b.vy = b.vy/sp*maxSp; }

  const elapsed = performance.now() - trk.startAt;
  const remain  = Math.max(0, trk.durationMs - elapsed);
  $("trkTimer").textContent = (remain/1000).toFixed(1) + "s";

  drawTrk();

  if(remain <= 0){
    trk.running = false;
    cancelAnimationFrame(trk.raf);
    $("trkTimer").textContent = "0.0s";

    trk.awaitingSubmit = true;

    // lock start until submit
    $("trkStart").disabled = true;
    $("trkSubmit").disabled = false;

    toast(`Round ${trk.round}/3 ended. Enter count, then Submit.`);
    return;
  }

  trk.raf = requestAnimationFrame(tickTrk);
}

function trkEnsureVisibleInit(){
  const ok = resizeCanvasForHiDpi();
  if(!ok) return;

  if(!trk.initialized){
    initBall();
    drawTrk();
    trk.initialized = true;
  }else{
    drawTrk();
  }
}

window.addEventListener("resize", ()=>{
  if($("tab-tests").style.display !== "none"){
    trkEnsureVisibleInit();
  }
});

$("trkStart").addEventListener("click", ()=>{
  trkEnsureVisibleInit();

  if(trk.running) return;

  if(trk.awaitingSubmit){
    toast("Submit your count first.");
    return;
  }

  if(trk.round >= 3){
    toast("Tracking finished (3/3).");
    $("trkStart").disabled = true;
    return;
  }

  trk.round++;
  trk.trueHits = 0;

  $("trkRound").textContent = trk.round;
  $("trkResult").textContent = "‚Äî";
  $("trkGuess").value = "";

  initBall();

  trk.running = true;
  trk.startAt = performance.now();

  // lock buttons during round
  $("trkStart").disabled = true;
  $("trkSubmit").disabled = true;

  toast(`Tracking started (Round ${trk.round}/3).`);
  trk.raf = requestAnimationFrame(tickTrk);
});

$("trkSubmit").addEventListener("click", ()=>{
  if(trk.running){ toast("Wait for the round to end."); return; }
  if(trk.round === 0){ toast("Start a round first."); return; }
  if(!trk.awaitingSubmit){ toast("Finish the round first."); return; }

  // prevent double-submit
  if(trk.errors.length >= trk.round){
    toast("Already submitted this round.");
    return;
  }

  const guess = Number($("trkGuess").value);
  if(!Number.isFinite(guess) || guess < 0){
    toast("Enter a valid count.");
    return;
  }

  const trueHits = trk.trueHits;
  const denom = Math.max(trueHits, 1);
  const errPct = Math.abs(guess - trueHits) / denom * 100;

  trk.errors.push(errPct);

  $("trkResult").textContent =
    `Round ${trk.round}/3 ‚Ä¢ true=${trueHits}, guess=${guess}, err=${errPct.toFixed(1)}%`;

  trk.awaitingSubmit = false;

  // after 3 rounds -> finalize pack metric as average error
  if(trk.errors.length >= 3){
    const avgErr = trk.errors.reduce((a,b)=>a+b,0) / trk.errors.length;

    pack.tracking.done = true;
    pack.tracking.errorPct = avgErr;
    pack.tracking.trueHits = null;
    pack.tracking.guess = null;

    $("trkStart").disabled = true;
    $("trkSubmit").disabled = true;

    toast(`Tracking complete ‚úì Avg err ${avgErr.toFixed(1)}%`);
    updateGate();
    return;
  }

  // enable next round start
  $("trkStart").disabled = false;
  $("trkSubmit").disabled = true;

  toast(`Submitted ‚úì Start round ${trk.round+1}/3`);
  updateGate();
});

// initial button state
$("trkStart").disabled = false;
$("trkSubmit").disabled = true;


/* =========================
   Finalize & API
   ========================= */
function evaluatePack(){
  const blSaved=loadBaseline();
  const bl=blSaved || defaultBaseline();
  const usedDefault=!blSaved;

  const curr={
    reactionBestMs: pack.reaction.bestMs,
    memoryAvgLen:   pack.memory.avgLen,
    trackingErrorPct: pack.tracking.errorPct
  };

  // Reaction: higher ms is worse
  const degR=Math.max(0, pctWorse(curr.reactionBestMs, bl.reactionBestMs));
  // Memory: lower avg length is worse
  const degM=Math.max(0, pctLower(curr.memoryAvgLen, bl.memoryAvgLen));
  // Tracking: higher error is worse
  const degT=Math.max(0, pctWorse(curr.trackingErrorPct, bl.trackingErrorPct));

  const effR=applyLeniency(degR);
  const effM=applyLeniency(degM);
  const effT=applyLeniency(degT);

  const overall=(effR*0.45 + effM*0.30 + effT*0.25);
  const cls=classifyRisk(overall);

  evaluation={ done:true, risk:cls.risk, overallDegradationPct:overall, usedDefaultBaseline:usedDefault };

  if(cls.risk==="expected") setRiskPill("good","Expected");
  else if(cls.risk==="flag") setRiskPill("warn","Flag");
  else setRiskPill("bad","High risk");

  log(`Tests finalized ‚Üí ${cls.label} (eff. ${overall.toFixed(1)}%)`);
  toast(usedDefault ? "Using demo baseline. Save baseline." : `Evaluation: ${cls.label}`);
  updateGate();
}

$("btnFinalize").addEventListener("click", ()=>{
  if(!canFinalizePack()){ toast("Complete all 3 tests first."); return; }
  evaluatePack();
});

$("btnSendApi").addEventListener("click", ()=>{
  if(!evaluation.done){ toast("Finalize first."); return; }
  const payload={
    employeeId:"DEMO-KEVIN",
    siteId:"SITE-001",
    capturedAt:new Date().toISOString(),
    location:{
      mode:locationMode,
      distanceToSiteM:Math.round(computeDistanceToSite()),
      insideGeofence: computeDistanceToSite()<=HOST.radiusM
    },
    results:{
      reactionBestMs: pack.reaction.bestMs,
      memoryAvgLen: Number(pack.memory.avgLen.toFixed(2)),
      trackingErrorPct:Number(pack.tracking.errorPct.toFixed(2)),
      overallEffectiveDegradationPct:Number(evaluation.overallDegradationPct.toFixed(2)),
      risk:evaluation.risk
    }
  };
  console.log("MOCK SEND TO PAYROLL API:", payload);
  log("Sent results to Payroll API (mock).");
  toast("Sent (mock). Check console.");
});

/* Baseline save/delete */
$("btnSaveBaseline").addEventListener("click", ()=>{
  if(!canFinalizePack()){ toast("Complete tests first."); return; }
  const bl={
    savedAt:Date.now(),
    reactionBestMs: pack.reaction.bestMs,
    memoryAvgLen: pack.memory.avgLen,
    trackingErrorPct: pack.tracking.errorPct
  };
  saveBaseline(bl);
  renderBaseline();
  log("Baseline saved (local).");
  toast("Baseline saved.");
});
$("btnClearBaseline").addEventListener("click", ()=>{
  clearBaseline();
  renderBaseline();
  log("Baseline deleted.");
  toast("Baseline deleted.");
});

/* Tests subtitle */
setInterval(()=>{
  const done=[pack.reaction.done, pack.memory.done, pack.tracking.done].filter(Boolean).length;
  $("testsSubtitle").textContent = `${done}/3 complete`;
}, 250);

/* =========================
   Init
   ========================= */
setRiskPill("", "No test yet");
log("APT AUTH demo ready.");
updateGate();

// Start on clock tab
showTab("clock");
</script>
</body>
</html>
